- hosts: role_master
  tasks:

  - name: Create .docker folder
    file:
      path: /home/azureuser/.docker
      state: directory
      mode: '0755'

  - name: copy the docker config file
    become: yes
    copy: 
      src: $JENKINS_HOME/.docker/config.json
      dest: /home/azureuser/.docker/config.json

  - name: deploy petclinic application
    shell: |

      helm registry login helmchartrepo.azurecr.io \
        --username helmchartrepo \
        --password fo+P1uVVyyxyJL7XyZDnsgt0WuDQtZV9S16jquLNm5+ACRCbfyLm

      kubectl create ns petclinicdev
      kubectl delete secret regcred -n petclinicdev || true
      kubectl create secret generic regcred -n petclinicdev \
        --from-file=.dockerconfigjson=/home/azureuser/.docker/config.json \
        --type=kubernetes.io/dockerconfigjson

      helm install petclinicapprelease  oci://helmchartrepo.azurecr.io/stable-petclinic --version ${BUILD_NUMBER} --namespace petclinicdev
      helm get manifest petclinicapprelease

  




